<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>案例管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/element-ui/2.15.6/theme-chalk/index.css">
    <style>
        .toolbar {
            padding-bottom: 0px;
        }
        .texttitle {
            color: black;
        }
        .textbody {
            color: black;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div style="margin-top: 10px;">
            <button id="toggle-collect" class="el-button el-button--primary el-button--plain">查看个人收藏案例</button>
        </div>
        <div class="el-divider"></div>
        <!-- 全部案例表格 -->
        <div id="all-case-table">
            <!-- 条件搜索框 -->
            <div class="toolbar">
                <form class="demo-form-inline" id="search-form">
                    <select id="car-series" class="el-select">
                        <option value="">品牌</option>
                        <!-- 动态添加品牌选项 -->
                    </select>
                    <select id="car-type" class="el-select">
                        <option value="">车型</option>
                        <!-- 动态添加车型选项 -->
                    </select>
                    <input type="text" id="keyword" class="el-input" placeholder="故障件关键词">
                    <button type="button" class="el-button el-button--primary" onclick="searchData()">查询</button>
                </form>
            </div>

            <table class="el-table">
                <thead>
                    <tr>
                        <th>案例ID</th>
                        <th>车系</th>
                        <th>车型</th>
                        <th>故障描述</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="table-data">
                    <!-- 动态添加表格数据 -->
                </tbody>
            </table>
        </div>

        <!-- 个人收藏案例表格 -->
        <div id="collect-case-table" style="display: none;">
            <!-- 操作框 -->
            <div class="toolbar">
                <form class="demo-form-inline" id="collect-search-form">
                    <select id="collect-car-series" class="el-select">
                        <option value="">品牌</option>
                        <!-- 动态添加品牌选项 -->
                    </select>
                    <select id="collect-car-type" class="el-select">
                        <option value="">车型</option>
                        <!-- 动态添加车型选项 -->
                    </select>
                    <input type="text" id="collect-keyword" class="el-input" placeholder="故障件关键词">
                    <button type="button" class="el-button el-button--primary" onclick="searchStarData()">按条件查询</button>
                    <button type="button" class="el-button el-button--danger" onclick="delCollectCase()">移除案例</button>
                </form>
            </div>

            <table class="el-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>案例ID</th>
                        <th>车系</th>
                        <th>车型</th>
                        <th>故障描述</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="collect-table-data">
                    <!-- 动态添加表格数据 -->
                </tbody>
            </table>
        </div>

        <!-- 弹窗 -->
        <div id="case-dialog" class="el-dialog__wrapper" style="display: none;">
            <div class="el-dialog" role="dialog" aria-modal="true" aria-label="故障案例">
                <div class="el-dialog__header">
                    <span class="el-dialog__title">故障案例</span>
                    <button type="button" class="el-dialog__headerbtn" aria-label="Close" onclick="closeDialog()">
                        <i class="el-dialog__close el-icon el-icon-close"></i>
                    </button>
                </div>
                <div class="el-dialog__body">
                    <div class="el-descriptions">
                        <div class="el-descriptions__header">车辆基本信息</div>
                        <div class="el-descriptions__body">
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">案例ID</span>
                                <span class="el-descriptions-item__content" id="dialog-case-id"></span>
                            </div>
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">所属品牌</span>
                                <span class="el-descriptions-item__content" id="dialog-brand"></span>
                            </div>
                        </div>
                    </div>
                    <div class="el-descriptions" style="margin-top: 20px;">
                        <div class="el-descriptions__header">重大信息</div>
                        <div class="el-descriptions__body el-descriptions__body--colon">
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">重大报告编号</span>
                                <span class="el-descriptions-item__content" id="dialog-report-id"></span>
                            </div>
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">引擎编号</span>
                                <span class="el-descriptions-item__content" id="dialog-engine-id"></span>
                            </div>
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">引擎类型</span>
                                <span class="el-descriptions-item__content" id="dialog-engine-type"></span>
                            </div>
                        </div>
                    </div>
                    <div class="el-descriptions" style="margin-top: 20px;">
                        <div class="el-descriptions__body el-descriptions__body--colon">
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">故障描述</span>
                                <span class="el-descriptions-item__content" id="dialog-fault-desc"></span>
                            </div>
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">故障原因</span>
                                <span class="el-descriptions-item__content" id="dialog-fault-reason"></span>
                            </div>
                            <div class="el-descriptions-item">
                                <span class="el-descriptions-item__label">解决方案</span>
                                <span class="el-descriptions-item__content" id="dialog-solution"></span>
                            </div>
                        </div>
                    </div>
                    <div class="el-divider">案例评分</div>
                    <div class="el-rate" id="dialog-rate" style="width: 125px; margin: 0 auto;"></div>
                </div>
                <div class="el-dialog__footer">
                    <div class="dialog-footer">
                        <button type="button" class="el-button el-button--primary" onclick="closeDialog()">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/element-ui/2.15.6/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const cars = ['大众', '宝马', '奔驰', '奥迪', '本田', '日产', '沃尔沃', '丰田'];
        const cars2 = ['卡罗拉', '凯美瑞', '科鲁兹', 'C级', '朗逸', '迈腾', '5系'];

        const dialog = document.getElementById('case-dialog');
        let caseDetails = {};
        let C_Review = null;

        function showDialog(details, review) {
            caseDetails = details;
            C_Review = review;
            document.getElementById('dialog-case-id').innerText = details.F_PKId;
            document.getElementById('dialog-brand').innerText = details.F_ProModel;
            document.getElementById('dialog-report-id').innerText = details.F_ClaimCode;
            document.getElementById('dialog-engine-id').innerText = details.F_EngCode;
            document.getElementById('dialog-engine-type').innerText = details.F_EngType;
            document.getElementById('dialog-fault-desc').innerText = details.F_FaultDesc;
            document.getElementById('dialog-fault-reason').innerText = details.F_FaultReason;
            document.getElementById('dialog-solution').innerText = details.F_SloveFault;

            const rate = document.getElementById('dialog-rate');
            rate.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = 'el-rate__icon el-icon-star-off';
                if (i <= C_Review) {
                    star.classList.add('el-rate__icon--full');
                }
                star.dataset.value = i;
                star.onclick = () => updateRate(i);
                rate.appendChild(star);
            }

            dialog.style.display = 'block';
        }

        function closeDialog() {
            dialog.style.display = 'none';
        }

        function updateRate(rate) {
            axios.get('http://8.137.80.44:8081/api/grade/update', {
                params: {
                    fPkId: caseDetails.F_PKId,
                    rate: String(rate)
                }
            }).then(response => {
                alert('评分数据已成功更新');
                C_Review = rate;
                showDialog(caseDetails, rate);
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function fetchTableData() {
            axios.get('http://8.137.80.44:8081/api/fault/all').then(response => {
                populateTable(response.data, 'table-data');
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function fetchCollectTableData() {
            axios.get('http://8.137.80.44:8081/api/fault/starlist').then(response => {
                populateTable(response.data, 'collect-table-data');
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function populateTable(data, tableId) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.F_PKId}</td>
                    <td>${item.F_ProModel}</td>
                    <td>${item.F_ProSerie}</td>
                    <td>${item.F_FaultDesc}</td>
                    <td>
                        <button class="el-link el-link--primary" onclick='showDetails(${JSON.stringify(item)})'>查看详情</button>
                        <button class="el-link el-link--primary" onclick='addCollectCase(${JSON.stringify(item)})'>收藏</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function showDetails(rowdata) {
            axios.get('http://8.137.80.44:8081/api/grade/get', {
                params: {
                    fPkId: rowdata.F_PKId
                }
            }).then(response => {
                showDialog(rowdata, Number(response.data.C_Review));
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function addCollectCase(rowdata) {
            axios.get('http://8.137.80.44:8081/api/fault/addstarlist', {
                params: {
                    F_PKId: rowdata.F_PKId
                }
            }).then(response => {
                if (response.data == 1) {
                    alert('收藏成功！');
                    fetchCollectTableData();
                } else if (response.data == -1) {
                    alert('此案例已经收藏了！');
                }
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function delCollectCase(rowdata) {
            axios.get('http://8.137.80.44:8081/api/fault/delstarcase', {
                params: {
                    F_PKId: rowdata.F_PKId
                }
            }).then(response => {
                if (response.data == 1) {
                    alert('移除成功！');
                    fetchCollectTableData();
                }
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function searchData() {
            const carSeries = document.getElementById('car-series').value;
            const carType = document.getElementById('car-type').value;
            const keyword = document.getElementById('keyword').value;

            axios.get('http://8.137.80.44:8081/api/fault/findAppointFaults', {
                params: {
                    F_FaultDescKeyword: keyword,
                    F_ProSerie: carType,
                    F_ProModel: carSeries
                }
            }).then(response => {
                populateTable(response.data, 'table-data');
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        function searchStarData() {
            const carSeries = document.getElementById('collect-car-series').value;
            const carType = document.getElementById('collect-car-type').value;
            const keyword = document.getElementById('collect-keyword').value;

            axios.get('http://8.137.80.44:8081/api/fault/findAppointStarFaults', {
                params: {
                    F_FaultDescKeyword: keyword,
                    F_ProSerie: carType,
                    F_ProModel: carSeries
                }
            }).then(response => {
                populateTable(response.data, 'collect-table-data');
            }).catch(error => {
                console.error('请求失败:', error);
            });
        }

        document.getElementById('toggle-collect').onclick = function() {
            const allCaseTable = document.getElementById('all-case-table');
            const collectCaseTable = document.getElementById('collect-case-table');
            const isCollect = collectCaseTable.style.display === 'block';

            if (isCollect) {
                allCaseTable.style.display = 'block';
                collectCaseTable.style.display = 'none';
                this.innerText = '查看个人收藏案例';
            } else {
                allCaseTable.style.display = 'none';
                collectCaseTable.style.display = 'block';
                this.innerText = '查看全部案例';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchTableData();
            fetchCollectTableData();

            const carSeriesSelect = document.getElementById('car-series');
            const carTypeSelect = document.getElementById('car-type');
            const collectCarSeriesSelect = document.getElementById('collect-car-series');
            const collectCarTypeSelect = document.getElementById('collect-car-type');

            cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.innerText = car;
                carSeriesSelect.appendChild(option);
                collectCarSeriesSelect.appendChild(option.cloneNode(true));
            });

            cars2.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.innerText = car;
                carTypeSelect.appendChild(option);
                collectCarTypeSelect.appendChild(option.cloneNode(true));
            });
        });
    </script>
</body>
</html>
